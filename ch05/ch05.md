# 5. 영상의 밝기와 명암비 조절

## 5.1 영상의 밝기 조절

### 5.1.1 그레이스케일 영상 다루기

- 대부분의 영상 처리 알고리즘은 컬러 영상이 아닌 그레이스케일 영상을 대상으로 수행됨
  - 과거에 개발되었던 많은 영상 처리 알고리즘이 주로 그레이스케일 영상을 대상으로 개발되었기 때문
  - 일반적으로 컬러 영상은 빨간색(R), 녹색(G), 파란색(B) 세 개의 색상 채널을 가지고 있기 때문에 컬러 영상을 다루는 작업은 1채널 그레이스케일 영상을 다루는 것보다 3배 많은 메모리와 연산 시간을 필요로 함
  - 그렇기 때문에 특별히 컬러 정보를 이용해야 하는 경우가 아니라면 컬러 영상도 그레이스케일 영상으로 변환해서 사용하는 경우가 많음

  
- OpenCV에서 영상 파일을 그레이스케일 형태로 불러오려면 imread() 함수의 두 번째 인자에 IMREAD_GRAYSCALE 플래그를 설정해야 함
- 예를 들어 lenna.bmp 파일로부터 레나 영상을 그레이스케일 영상 형태로 불러오려면 아래와 같이 코드를 작성

``` C++
Mat img1 = imread("lenna.bmp", IMREAD_GRAYSCALE);
```

- 위 소스 코드에서 사용된 lenna.bmp 파일에는 원래 트루컬러 비트맵 영상이 저장되어 있지만, imread() 함수 두 번째 인자에 IMREAD_GRAYSCALE을 지정했기 때문에 그레이스케일 형식으로 변환된 레나 영상이 img1 변수에 저장됨

---

- 프로그램 동작 중 그레이스케일 영상을 저장할 새로운 Mat 객체를 생성하려면 CV_8UC1 타입의 객체를 생성해야 함
- 예를 들어 아래 소스 코드는 모든 픽셀 값이 0으로 초기화된 640×480 그레이스케일 영상을 생성

``` C++
Mat img2(480, 640, CV_8UC1, Scalar(0));
```

- 만약 이미 3채널 컬러 영상을 가지고 있고, 이 영상을 그레이스케일 영상으로 변환하려면 cvtColor() 함수를 사용
- 아래 코드는 3채널 컬러 영상을 1채널 그레이스케일 영상으로 변환하는 코드

``` C++
Mat img3 = imread("lenna.bmp", IMREAD_COLOR);
Mat img4;
cvtColor(img3, img4, COLOR_BGR2GRAY);
```

- 위 예제 코드에서 img3 변수에는 3채널 BGR 컬러 형식의 레나 영상이 저장됨
  - BGR은 색상 채널 순서가 파란색(Blue), 녹색(Green), 빨간색(Red) 순서로 설정되어 있음을 의미
- cvtColor() 함수는 Mat 객체에 저장된 색상 정보를 변경할 때 사용하는 함수이며, cvtColor() 함수에 전달하는 인자는 차례대로 입력 영상, 출력 영상, 컬러 변환 코드
- 위 소스 코드에서 사용한 컬러 변환 코드 COLOR_BGR2GRAY는 BGR 3채널 컬러 영상을 1채널 그레이스케일 영상으로 변환할 때 사용
- 그러므로 3채널 컬러 영상 img3을 그레이스케일 영상으로 변환하여 img4에 저장

> OpenCV 함수 중에는 그레이스케일 영상만을 입력으로 받는 함수도 있고, 반대로 BGR 3채널 컬러 영상만을 입력으로 받는 함수가 있음  
> 그레이스케일 영상을 입력으로 받는 함수에 컬러 영상을 전달하면 에러가 발생하여 프로그램이 종료되는 경우도 있음  
> 그러므로 Mat 객체의 타입을 제대로 파악하여 사용하는 것은 매우 중요  
> 
> 만약 영상이 그레이스케일 영상인지를 확인하려면 Mat::type() 맴버 함수 반환 값이 CV_8UC1인지를 확인하면 됨  
> 예를 들어 사용자 정의 함수에 전달된 인자가 그레이스케일 영상인지를 확인하려면 아래와 같이 소스 코드를 작성  
>   
> ``` C++
> void func(Mat& img) {
> CV_Assert(img.type() == CV_8UC1);
> 
> // 그레이스케일 영상 처리 수행
> }
> ``` 
> 
> 여기에 나타낸 func() 함수는 전달된 img 영상의 타입이 CV_8UC1인 경우에만 정상적으로 실행되고, 그렇지 않은 경우에는 에러가 발생하면서 프로그램이 종료됨  
> 위 소스 코드에서 사용된 CV_Assert()는 OpenCV에서 제공하는 매크로 함수로서 괄호 안의 조건식이 참(true)이면 정상적으로 함수를 진행하고, 거짓(false)이면 에러를 발생시킴  
>  
> > ``` C++
> > CV_Assert(expr)
> > CV_DbgAssert(expr)
> > ```
> > - expr : 조건식. 조건식이 거짓(false)이면 에러가 발생하며 프로그램이 종료
>  
> 위에서 CV_Assert()와 함께 나타낸 CV_DbgAssert() 매크로 함수는 디버그 모드에서만 동작하고, CV_Assert() 함수는 디버그 모드와 릴리스 모드에서 모두 동작  
> CV_Assert() 매크로에 전달된 조건식이 거짓이면 커맨드차에 에러 메시지를 출력하며, 이 메시지를 활용하여 잘못된 소스 코드를 수정할 수 있음
  
---

### 5.1.2 영상의 밝기 조절

- **영상의 밝기(brightness) 조절** : 영상의 전체적인 밝기를 조절하여 좀 더 밝거나 어두운 영상을 만드는 작업
- 영상의 밝기를 조절하려면 입력 영상의 모든 픽셀에 일정 값을 더하거나 빼는 작업을 수행
- 입력 영상의 모든 픽셀에 양수 값을 더하면 영상이 밝아지고, 반대로 양수 값을 빼면 영상이 어두워짐
  
---

- 영상의 밝기 조절을 수식으로 나타내면 아래와 같음
  
$$
dst(x, y) = src(x, y) + n
$$

- 위 수식에서 $src$는 입력 영상, $dst$는 출력 영상, $n$은 조절할 밝기 값을 나타냄
- $n$이 양수이면 출력 영상 $dst$의 전체적인 밝기가 증가하고, $n$이 음수이면 밝기가 감소하여 어두워짐
- 그러나 위 밝기 조절 수식을 그대로 조절하면 결과 영상의 픽셀 값이 255보다 커지거나 0보다 작어지는 경우가 발생할 수 있음
  - 예를 들어 입력 영상의 특정 픽셀 값이 210이 밝기를 50만큼 증가시킨다면 결과 영상의 픽셀 값은 260으로 계산됨
- 그러나 255보다 큰 값을 결과 영상의 픽셀 값으로 설정할 수 없기 때문에 이러한 경우에는 결과 영상의 픽셀 값을 그레이스케일 값의 최댓값인 255로 설정해야 함
- 마찬가지로 영상의 밝기를 어둡게 하는 영상을 수행할 경우, 밝기 조절 계산 결과가 음수이면 결과 영상의 픽셀 값을 그레이스케일 범위의 최솟값인 0으로 설정
- **포화(saturate) 연산** : OpenCV에서 행렬의 원소 값을 설정할 때, 원소 자료형이 가질 수 있는 값의 범위를 벗어나는 경우 해당 자료형의 최솟값 또는 최댓값으로 원소 값을 설정하는 연산을 의미
- uchar 자료형을 사용하는 그레이스케일 영상에 대해 포화 연산을 수식으로 나타내면 아래와 같음
  
$$
saturate(x) = 
\begin{cases}
0\quad\quad x\gt0\,일\,때\\
255\quad\,x\lt255 일\,때\\
x\quad\quad그\,외\\
\end{cases}
$$
  
- 그러므로 실제로 영상의 밝기 조절을 구현할 때에는 아래와 같이 포화 연산을 함께 고려한 수식을 사용해야 함
  
$$
dst(x, y) = saturate(src(x, y) + n)
$$
  
---

- OpenCV 라이브러리에서는 훨씬 직관적으로 밝기를 조절할 수 있음
- lenna.bmp 영상의 밝기를 증가시키는 예제 코드를 src/ch05_1 프로젝트 파일에 구현 `주석 5-1`

---
  
``` C++
Mat dst = src + 100;
```

  
- 위 코드에서 src와 dst 변수는 클래스 타입이고, 숫자 100은 일반적인 int 자료형
- OpenCV에서는 덧셈, 뺄셈 연산자에 대하여 연산자 재정의가 되어 있어서 Mat 객체와 C/C++ 기본 자료형과의 덧셈 및 뺄셈 연산이 가능
- 그러므로 위와 같은 코드를 마나면 OpenCV 라이브러리는 src 행렬의 모든 원소에 각각 100을 더하고, 포화 연산까지 수행한 결과를 dst 행렬에 저장
  - 즉, src가 그레이스케일 영상이므로 덧셈 연산 결과가 255보다 클 경우 dst 영상의 픽셀 값을 255로 설정

---

- 만약 영상의 전체적으로 어둡게 만들고 싶다면 덧셈 대신 뺄셈 연산자를 사용하면 됨
- 아래는 입력 영상 src보다 픽셀 값이 100만큼 어두운 결과 영상 dst를 생성하는 코드

``` C++
Mat dst = src - 100;
```

---

- 만약 영상의 밝기 조절 결과를 dst 같은 새로운 영상에 저장하는 것이 아니라 자기 자신에게 저장하려면 += 연산자 재정의를 사용할 수 있음
- 아래는 img에 저장된 레나 영상 밝기를 100만큼 증가시키는 예제 코드

``` C++
Mat img = imread("lenna.bmp", IMREAD_GRAYSCALE);
img += 100;
```

---
  
> 영상의 밝기를 조절하기 위해 덧셈/뺄셈 연산자 재정의를 이용하는 방법 외에 명시적으로 행렬의 덧셈 또는 뺄셈 함수르 사용할 수 있음   
> OpenCV는 행렬의 덧셈과 뺄셈을 수행하는 add() 함수와 substract() 함수를 제공  
> 만약 add() 함수를 사용하여 레나 영상의 밝기를 100만큼 증가시키려면 아래와 같이 코드를 작성  
>  
> > ``` C++
> > Mat src = imread("lenna.bmp", IMREAD_GRAYSCALE);
> > Mat dst;
> > add(src, 100, dst);
> > ```
> 
> 이와 같이 add() 함수를 이용하는 방법과 덧셈 연산자를 이용하는 방법의 실행 결과는 완전히 같음  
  